// Copyright 2026 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package vulns_test

import (
	"testing"

	"github.com/google/osv-scalibr/enricher/vulnmatch/osvlocal/internal/vulns"
	"github.com/google/osv-scalibr/extractor"
	"github.com/google/osv-scalibr/extractor/filesystem/os/dpkg/metadata"
	"github.com/google/osv-scalibr/purl"
	"github.com/ossf/osv-schema/bindings/go/osvconstants"
	osvpb "github.com/ossf/osv-schema/bindings/go/osvschema"
)

func expectIsAffected(t *testing.T, vuln *osvpb.Vulnerability, version string, expectAffected bool) {
	t.Helper()

	pkg := &extractor.Package{
		Name:     "my-package",
		Version:  version,
		PURLType: purl.TypeNPM,
	}

	if vulns.IsAffected(vuln, pkg) != expectAffected {
		if expectAffected {
			t.Errorf("Expected OSV to affect package version %s but it did not", version)
		} else {
			t.Errorf("Expected OSV not to affect package version %s but it did", version)
		}
	}
}

func buildOSVWithAffected(affected ...*osvpb.Affected) *osvpb.Vulnerability {
	return &osvpb.Vulnerability{
		Id:        "1",
		Published: nil,
		Modified:  nil,
		Details:   "This is an open source vulnerability!",
		Affected:  affected,
	}
}

func buildEcosystemAffectsRange(events ...*osvpb.Event) *osvpb.Range {
	return &osvpb.Range{Type: osvpb.Range_ECOSYSTEM, Events: events}
}

func buildSemverAffectsRange(events ...*osvpb.Event) *osvpb.Range {
	return &osvpb.Range{Type: osvpb.Range_SEMVER, Events: events}
}

func TestOSV_IsAffected_AffectsWithEcosystem_DifferentEcosystem(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemPyPI), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(&osvpb.Event{Introduced: "0"}),
			},
		},
	)

	for _, v := range []string{"1.0.0", "1.1.1", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}
}

func TestOSV_IsAffected_AffectsWithEcosystem_SingleAffected(t *testing.T) {
	var vuln *osvpb.Vulnerability

	// "Introduced: 0" means everything is affected
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(&osvpb.Event{Introduced: "0"}),
			},
		},
	)

	for _, v := range []string{"1.0.0", "1.1.1", "2.0.0"} {
		expectIsAffected(t, vuln, v, true)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// "Fixed: 1" means all versions after this are not vulnerable
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// multiple fixes and introduced
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "3.2.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// "LastAffected: 1" means all versions after this are not vulnerable
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{LastAffected: "1"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc", "1.0.0"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.1", "1.1.0", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// mix of fixes, last_known_affected, and introduced
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{LastAffected: "3.1.9"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc", "3.1.9"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_AffectsWithEcosystem_MultipleAffected(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
				),
			},
		},
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "3.2.0"},
				),
			},
		},
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "3.3.0"},
					&osvpb.Event{LastAffected: "3.5.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"3.3.1", "3.4.5"} {
		expectIsAffected(t, vuln, v, true)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_AffectsWithEcosystem_Unsorted(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{LastAffected: "3.1.9"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc", "3.1.9"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// zeros with build strings
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			// golang.org/x/sys
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Fixed: "0.0.0-20220412211240-33da011f77ad"},
					&osvpb.Event{Introduced: "0"},
				),
			},
		},
		&osvpb.Affected{
			// golang.org/x/net
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildEcosystemAffectsRange(
					&osvpb.Event{Introduced: "0.0.0-20180925071336-cf3bd585ca2a"},
					&osvpb.Event{Fixed: "0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.14.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"0.0.0-20180925071336-cf3bd585ca2a"} {
		expectIsAffected(t, vuln, v, true)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_AffectsWithSemver_DifferentEcosystem(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemPyPI), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(&osvpb.Event{Introduced: "0"}),
			},
		},
	)

	for _, v := range []string{"1.0.0", "1.1.1", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}
}

func TestOSV_IsAffected_AffectsWithSemver_SingleAffected(t *testing.T) {
	var vuln *osvpb.Vulnerability

	// "Introduced: 0" means everything is affected
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(&osvpb.Event{Introduced: "0"}),
			},
		},
	)

	for _, v := range []string{"v1.0.0", "v1.1.1", "v2.0.0"} {
		expectIsAffected(t, vuln, v, true)
	}

	// "Fixed: 1" means all versions after this are not vulnerable
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1.0.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// multiple fixes and introduced
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "3.2.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// "LastAffected: 1" means all versions after this are not vulnerable
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{LastAffected: "1.0.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc", "1.0.0"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.1", "1.1.0", "2.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// mix of fixes, last_known_affected, and introduced
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{LastAffected: "3.1.9"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_AffectsWithSemver_MultipleAffected(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Fixed: "1"},
				),
			},
		},
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "3.2.0"},
				),
			},
		},
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "3.3.0"},
					&osvpb.Event{LastAffected: "3.5.0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"3.3.1", "3.4.5", "3.5.0"} {
		expectIsAffected(t, vuln, v, true)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_AffectsWithSemver_Unsorted(t *testing.T) {
	// mix of fixes, last_known_affected, and introduced
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
					&osvpb.Event{Introduced: "2.1.0"},
					&osvpb.Event{Fixed: "1"},
					&osvpb.Event{LastAffected: "3.1.9"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.1.0", "0.0.0.1", "1.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"1.0.0", "1.1.0", "2.0.0rc2", "2.0.1"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"2.1.1", "2.3.4", "3.0.0", "3.0.0-rc"} {
		expectIsAffected(t, vuln, v, true)
	}

	for _, v := range []string{"3.2.0", "3.2.1", "4.0.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)

	// zeros with build strings
	vuln = buildOSVWithAffected(
		&osvpb.Affected{
			// golang.org/x/sys
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Fixed: "0.0.0-20220412211240-33da011f77ad"},
					&osvpb.Event{Introduced: "0"},
				),
			},
		},
		&osvpb.Affected{
			// golang.org/x/net
			Package: &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0.0.0-20180925071336-cf3bd585ca2a"},
					&osvpb.Event{Fixed: "0"},
				),
			},
		},
	)

	for _, v := range []string{"0.0.0", "0.14.0"} {
		expectIsAffected(t, vuln, v, false)
	}

	for _, v := range []string{"0.0.0-20180925071336-cf3bd585ca2a"} {
		expectIsAffected(t, vuln, v, true)
	}

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_IsAffected_OnlyVersions(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package:  &osvpb.Package{Ecosystem: string(osvconstants.EcosystemNPM), Name: "my-package"},
			Versions: []string{"1.0.0"},
		},
	)

	expectIsAffected(t, vuln, "0.0.0", false)
	expectIsAffected(t, vuln, "1.0.0", true)
	expectIsAffected(t, vuln, "1.0.0-beta1", false)
	expectIsAffected(t, vuln, "1.1.0", false)

	// an empty version should always be treated as affected
	expectIsAffected(t, vuln, "", true)
}

func TestOSV_EcosystemsWithSuffix(t *testing.T) {
	vuln := buildOSVWithAffected(
		&osvpb.Affected{
			Package: &osvpb.Package{Ecosystem: "Debian:12", Name: "my-package"},
			Ranges: []*osvpb.Range{
				buildSemverAffectsRange(
					&osvpb.Event{Introduced: "0"},
				),
			},
		},
	)

	pkg := &extractor.Package{
		Name:     "my-package",
		Version:  "0.0.0",
		PURLType: purl.TypeDebian,
		Metadata: &metadata.Metadata{
			OSID:        "Debian",
			OSVersionID: "12",
		},
	}

	if !vulns.IsAffected(vuln, pkg) {
		t.Errorf("Expected OSV to affect package version %s but it did not", "0.0.0")
	}
}
